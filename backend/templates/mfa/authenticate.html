{% load i18n %}
{% load allauth %}
{% load allauth static %}
{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<style>
  :root {
    --panel-red: #609926;
    --panel-dark-green: #2e3626;
    --panel-bg: #f4f6f8;
  }

  html, body {
    height: 100%;
  }

  body {
    display: flex;
    align-items: center;
    padding: 40px 0;
    background-color: var(--panel-bg);
    color: var(--panel-dark-green);
  }

  a {
    color: var(--panel-red);
  }

  a:hover {
    color: #435233;
    text-decoration: none;
  }

  .form-signin {
    width: 100%;
    max-width: 360px;
    padding: 24px;
    margin: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(20, 33, 66, 0.15);
  }

  .form-signin h1 {
    color: var(--panel-dark-green);
  }

  .form-control {
    margin-bottom: 12px;
    padding: 12px;
    font-size: 16px;
    border-radius: 4px;
  }

  .form-control:focus {
    border-color: var(--panel-red);
    box-shadow: 0 0 0 0.2rem rgba(207, 20, 43, 0.25);
  }

  .btn-primary {
    background-color: var(--panel-red);
    border-color: var(--panel-red);
    font-weight: 600;
  }

  .btn-primary:hover,
  .btn-primary:focus {
    background-color: #609926;
    border-color: #609926;
  }

  .btn-outline-primary {
    color: var(--panel-red);
    border-color: var(--panel-red);
    font-weight: 500;
  }

  .btn-outline-primary:hover {
    background-color: var(--panel-red);
    border-color: var(--panel-red);
    color: #fff;
  }

  .btn-outline-secondary {
    font-weight: 500;
  }

  .text-muted {
    color: #6c757d !important;
  }

  .copyright {
    font-size: 0.9rem;
  }
</style>

<div class="container-fluid text-center">

  {% url 'mfa_authenticate' as action_url %}

  <div class="form-signin">

    <h1 class="h3 mb-3 font-weight-normal">
      {% trans "Two-Factor Authentication" %}
    </h1>

    <p class="text-muted small mb-4">
      {% blocktranslate %}
        Your account is protected by two-factor authentication.
        Please enter your authenticator code.
      {% endblocktranslate %}
    </p>

    <form method="post" action="{{ action_url }}">
      {% csrf_token %}

      {% for field in form %}
        <label for="{{ field.id_for_label }}" class="sr-only">
          {{ field.label }}
        </label>

        <input
          type="{{ field.field.widget.input_type }}"
          name="{{ field.name }}"
          id="{{ field.id_for_label }}"
          class="form-control {% if field.errors %}is-invalid{% endif %}"
          placeholder="{{ field.label }}"
          value="{{ field.value|default_if_none:'' }}"
          {% if forloop.first %}autofocus{% endif %}
          required
        >

        {% if field.errors %}
          <div class="invalid-feedback d-block text-left">
            {{ field.errors|striptags }}
          </div>
        {% endif %}
      {% endfor %}

      <button
        class="btn btn-lg btn-primary btn-block"
        type="submit"
      >
        {% trans "Sign In" %}
      </button>

      {% if "webauthn" not in MFA_SUPPORTED_TYPES %}
        <button
          class="btn btn-link btn-block mt-2"
          type="submit"
          form="logout-from-stage"
        >
          {% trans "Cancel" %}
        </button>
      {% endif %}
    </form>

    {% if "webauthn" in MFA_SUPPORTED_TYPES %}
      <div class="mt-4">
        <hr>

        <h6 class="text-muted mb-3">
          {% trans "Alternative options" %}
        </h6>

        <button
          class="btn btn-outline-primary btn-block"
          id="mfa_webauthn_authenticate"
          type="button"
        >
          {% trans "Use a security key" %}
        </button>

        <button
          class="btn btn-outline-secondary btn-block mt-2"
          type="submit"
          form="logout-from-stage"
        >
          {% trans "Cancel" %}
        </button>
      </div>
    {% endif %}

    <p class="mt-5 mb-3 text-muted copyright">
      Copyright &copy; RansomNegotiator.
      All Rights Reserved.
    </p>

  </div>

</div>

<form
  id="logout-from-stage"
  method="post"
  action="{% url 'account_logout' %}">
  {% csrf_token %}
  <input type="hidden" name="next" value="{% url 'account_login' %}">
</form>

{% if "webauthn" in MFA_SUPPORTED_TYPES %}
  <form
    id="webauthn_form"
    method="post"
    action="{{ action_url }}">
    {% csrf_token %}
    {{ webauthn_form.as_p }}
  </form>

  {{ js_data|json_script:"js_data" }}
  {% include "mfa/webauthn/snippets/scripts.html" %}

  <script
    data-allauth-onload="allauth.webauthn.forms.authenticateForm"
    type="application/json">
{
  "ids": {
    "authenticate": "mfa_webauthn_authenticate",
    "credential": "{{ webauthn_form.credential.auto_id }}",
    "data": "js_data"
  }
}
  </script>
{% endif %}

{% endblock content %}